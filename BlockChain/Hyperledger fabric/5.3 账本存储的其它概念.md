### 世界状态

世界状态是指交易执行后，区块链上所有键的最新值。世界状态能提升链码的执行效率，例如使用 getState 方法只需要从世界状态读取数据，不需要直接读取区块数据，而读取区块效率较低。可以将世界状态理解为区块链上的缓存，离开状态数据库，区块链理论上依然可以工作。状态是所有交易日志的快照，可随时重构。peer 节点在启动时都会检查世界状态数据库是否与区块存储一致，若不一致，就需要协调，以区块存储中的数据为准。

Fabric 提供 LevelDB 与 CouchDB 作为状态数据库的存储引擎。LevelDB 只支持简单的 KV 操作，而 CouchDB 支持模糊查询 ，能支持更多应用场景。LevelDB 与 peer 节点在同一进程中，而 CouchDB 是第三方的独立数据库，所以需要通过网络通信的方式接入，增加了运维负担。与 Orderer 节点的共识机制不同，世界状态的数据库可以动态修改，即任何一次启动都可以重新选择数据库。

### 历史数据索引（可选）

历史数据索引作为可选组件，可以通过 peer 的配置进行动态修改。启用与否取决于智能合约是否由查询历史的需求，如果不需要查询历史，则可以不启用。

历史记录索引只记录了某个键值对在某区块的某条交易中被改变，且只记录改变动作，不记录具体改变结果。

如果需要读取历史，首先要先在历史数据索引中查询键值对的改变位置，然后从区块中读取对应交易。

历史数据索引使用 LevelDB。

### 区块存储

区块在 Fabric 中以文件快的形式存储，文件块的文件名格式为：blockfile_xxxxxx。当前文件快大小以硬编码方式定义为 64M，账本的最大容量则为 64M * 1000000。

区块读取方式：

* 区块文件流（blockfileStream）：读取文件快
* 区块流（blockStream）：在文件快中读取区块
* 区块迭代器（blocksItr）：在链条上读取区块

### 区块索引

区块索引的主要作用是快速定位区块，实现方式为将索引键（查询条件）与区块位置做映射关系，索引键可以是区块高度、区块哈希、交易哈希等，索引值由文件块编号、文件内偏移量和区块数据长度组成。

### 区块提交

1. 保存区块文件，即将区块文件保存到文件系统中。如果文件块未存满，则将区块追加到文件块后面，否则将创建新的文件块，将该区块作为文件块的第一个区块。区块存储完成后更新区块索引。即使交易为无效交易，依然会被存储到磁盘中，之所以如此设计，可能是为了保证 hash 的可验证性，因为区块 hash 由 orderer 节点生成，peer 节点接收到区块后只会验证存储，并不会重新计算 hash，如果把无效交易从区块中剔除，此操作会导致区块 hash 发生改变。
2. 更新世界状态，该步骤不会更新无效交易。
3. 更新历史状态（可选），将所有有效交易的写集，分别进行组合键的组合，插入到历史状态数据库中。

区块交易的三个步骤顺序执行，中间涉及到了文件操作、数据库的操作，如果任何一个步骤出错，都可能导致程序的崩溃，因此 peer 节点每次启动时都需要检查三者之间的数据是否一致，如果不一致，则以区块文件为准进行协调统一。